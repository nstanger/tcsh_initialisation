#!/bin/bash

BREW=/usr/local/bin/brew
LOGGER=/usr/local/bin/glogger
SLEEP=/usr/local/bin/gsleep
GREP=/usr/local/bin/ggrep
AWK=/usr/local/bin/gawk
PS=/bin/ps

if [ -z $1 ]
then
    delay=180
else
    delay=$1
fi

servers=$(${BREW} services list | ${GREP} started | ${GREP} 'mariadb\|postgres\|mongo' | ${AWK} '{print $1}')

$LOGGER Will restart $servers in $delay seconds...
$SLEEP $delay

for s in $servers
do
    $LOGGER Restarting $s...
    $BREW services restart $s

    # $SLEEP 10
    process=$(${BREW} services | ${GREP} $s | ${GREP} started)
    if [ -z "$process" ]
    then
        $LOGGER Failed to restart $s!
    else
        $LOGGER Restarted $s successfully.
    fi
done
